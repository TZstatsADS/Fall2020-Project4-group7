---
title: "WeightedRegression"
author: '-'
date: "2020/11/22"
output: html_document
---

```{r}
library(readr)
low <- read_csv("C:/Users/60171/Downloads/lowDim_dataset.csv")
high <- read_csv("C:/Users/60171/Downloads/highDim_dataset.csv")
```

## LowDim Dataset
```{r}
# Assume all covariates have an influence on the assignment to either the control or the treatment group
lr_low <- glm(A~., data=subset(low,select=-Y), family = binomial())
summary(lr_low)
```

```{r}
# Attaching propensity score to the low_dim dataset
low$psvalue <- predict(lr_low, type='response')

# Historgrams for propensity scores
low_treated <- low[low$A==1,]
hist(low_treated$psvalue)

low_controled <-low[low$A==0,]
hist(low_controled$psvalue)
#From two graphs we could see, there is sufficient overlap between the two groups
```


Weights for ATE: We define the weights using:
* for the treatment group: 1/low$psvalue
* for the control group: 1/(1-low$psvalue)
```{r}
# Estimation and storing weights using propensity score estimated using logistic regression
# Attaching weight to the lowdim dataset
low$weight.ATE <- ifelse(low$A == 1, 1/low$psvalue, 1/(1-low$psvalue))
```

```{r}
# Run weighted regression to find the ATE w/o variable selection
ATE_low_all <- lm(Y~A, data = low, weights = (weight.ATE))
summary(ATE_low_all)
```
```{r}
# select variables by weighted regression
weighted_lr_low <- lm(Y~.-psvalue, data = low, weights = (weight.ATE))
summary(weighted_lr_low)

# result shows we should not include v2, v4, v14
```

```{r}
delete <- names(low) %in% c("V2", "V4", "V14")
low_delete <- low[!delete]
ATE_low_selected <- lm(Y~A, data = low_delete , weights = (weight.ATE))
summary(ATE_low_selected)
```

